<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Submit New Posts to IndexNow</title>
<style>
  body { font-family: sans-serif; margin: 2rem; }
  button { margin-left: 1rem; }
  li { margin-bottom: 0.5rem; }
</style>
</head>
<body>
<h1>New Posts for IndexNow</h1>
<ul id="postsList">Loading...</ul>
<p id="response"></p>

<script>
// URL of your sitemap
const SITEMAP_URL = 'https://reviewindex.pages.dev/sitemap.xml?type=posts';

// Function to parse sitemap XML
async function fetchSitemap() {
    const res = await fetch(SITEMAP_URL);
    const xmlText = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, 'text/xml');
    const urls = Array.from(xml.querySelectorAll('url')).map(u => ({
        loc: u.querySelector('loc')?.textContent,
        lastmod: u.querySelector('lastmod')?.textContent
    }));
    return urls;
}

// Filter URLs posted in the last X hours
function filterRecentUrls(urls, hours = 48) {
    const now = new Date();
    return urls.filter(u => {
        if (!u.lastmod) return false;
        const lastModDate = new Date(u.lastmod);
        const diffHours = (now - lastModDate) / (1000 * 60 * 60);
        return diffHours <= hours;
    });
}

// Render list with submit buttons
function renderList(urls) {
    const list = document.getElementById('postsList');
    list.innerHTML = '';
    if (!urls.length) {
        list.textContent = 'No new posts in the last 48 hours.';
        return;
    }
    urls.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u.loc;

        const btn = document.createElement('button');
        btn.textContent = 'Submit';
        btn.onclick = () => submitUrl(u.loc, btn);

        li.appendChild(btn);
        list.appendChild(li);
    });

    // Optional: "Submit All" button
    const allBtn = document.createElement('button');
    allBtn.textContent = 'Submit All';
    allBtn.onclick = () => urls.forEach(u => submitUrl(u.loc));
    list.appendChild(document.createElement('br'));
    list.appendChild(allBtn);
}

// Send URL to Cloudflare Function
async function submitUrl(url, btn) {
    if (btn) btn.disabled = true;
    const responseEl = document.getElementById('response');
    try {
        const res = await fetch('/functions/submit-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });
        const result = await res.json();
        responseEl.textContent = `${url} â†’ ${result.message}`;
    } catch (err) {
        console.error(err);
        responseEl.textContent = `Error submitting ${url}`;
    } finally {
        if (btn) btn.disabled = false;
    }
}

// Main
(async function() {
    const urls = await fetchSitemap();
    const recentUrls = filterRecentUrls(urls, 48); // last 48 hours
    renderList(recentUrls);
})();
</script>
</body>
</html>
