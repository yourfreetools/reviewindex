<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Submit New Posts</title>
<style>
body { font-family: sans-serif; margin: 2rem; }
button { margin-left: 1rem; }
li { margin-bottom: 0.5rem; }
</style>
</head>
<body>
<h1>New Posts</h1>
<ul id="postsList">Loading...</ul>
<p id="response"></p>

<script>
function renderList(urls) {
    const list = document.getElementById('postsList');
    list.innerHTML = '';
    if (!urls.length) {
        list.textContent = 'No new posts in the last 48 hours.';
        return;
    }
    urls.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u.loc;

        const btn = document.createElement('button');
        btn.textContent = 'Submit';
        btn.onclick = () => submitUrl(u.loc, btn);

        li.appendChild(btn);
        list.appendChild(li);
    });

    const allBtn = document.createElement('button');
    allBtn.textContent = 'Submit All';
    allBtn.onclick = () => urls.forEach(u => submitUrl(u.loc));
    list.appendChild(document.createElement('br'));
    list.appendChild(allBtn);
}

async function submitUrl(url, btn) {
    if (btn) btn.disabled = true;
    const responseEl = document.getElementById('response');
    try {
        const res = await fetch('/functions/submit-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });
        const result = await res.json();
        responseEl.textContent = `${url} â†’ ${result.message}`;
    } catch (err) {
        responseEl.textContent = `Error submitting ${url}`;
    } finally {
        if (btn) btn.disabled = false;
    }
}

(async function() {
    try {
        const res = await fetch('/functions/fetch-new-posts');
        const recentUrls = await res.json();
        renderList(recentUrls);
    } catch (err) {
        console.error(err);
        document.getElementById('postsList').textContent = 'Error loading posts';
    }
})();
</script>
</body>
</html>
